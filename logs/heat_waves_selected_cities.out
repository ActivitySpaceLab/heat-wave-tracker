
R version 4.4.1 (2024-06-14) -- "Race for Your Life"
Copyright (C) 2024 The R Foundation for Statistical Computing
Platform: x86_64-pc-linux-gnu

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

- Project '~/research/heat-wave-tracker' loaded. [renv 1.1.4]
> # Title ####
> # For detecting and plotting heatwaves. 
> 
> rm(list=ls())
> 
> # Dependencies ####
> library(tidyverse)
── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.5
✔ forcats   1.0.0     ✔ stringr   1.5.1
✔ ggplot2   3.5.1     ✔ tibble    3.2.1
✔ lubridate 1.9.4     ✔ tidyr     1.3.1
✔ purrr     1.0.4     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors
> library(lubridate)
> library(data.table)

Attaching package: ‘data.table’

The following objects are masked from ‘package:lubridate’:

    hour, isoweek, mday, minute, month, quarter, second, wday, week,
    yday, year

The following objects are masked from ‘package:dplyr’:

    between, first, last

The following object is masked from ‘package:purrr’:

    transpose

> library(tidyverse)
> library(weathermetrics)
> library(sf)
Linking to GEOS 3.12.2, GDAL 3.9.1, PROJ 9.4.1; sf_use_s2() is TRUE
> library(gridExtra)

Attaching package: ‘gridExtra’

The following object is masked from ‘package:dplyr’:

    combine

> library(RcppRoll)
> 
> 
> # Selected cities ####
> these_munis = c("Barcelona", "Madrid", "València", "Zaragoza", "Sevilla")
> 
> # Spatial data on stations ####
> SPAIN_CRS = 25830
> 
> station_points = st_read("data/cartography/1da1315b/Estaciones_Completas.shp") %>% bind_rows(st_read("data/cartography/b29c8d56/Estaciones_Termometricas.shp")) %>% bind_rows(st_read("data/cartography/2aa58725/Estaciones_Automaticas.shp")) %>% bind_rows(st_read("data/cartography/8892d9c9/Estaciones_Pluviometricas.shp")) %>% st_transform(SPAIN_CRS)
Reading layer `Estaciones_Completas' from data source 
  `/home/palmer/research/heat-wave-tracker/data/cartography/1da1315b/Estaciones_Completas.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 111 features and 9 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: -17.8889 ymin: 27.81892 xmax: 4.215601 ymax: 43.56696
Geodetic CRS:  ETRS89
Reading layer `Estaciones_Termometricas' from data source 
  `/home/palmer/research/heat-wave-tracker/data/cartography/b29c8d56/Estaciones_Termometricas.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 975 features and 9 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: -15.54334 ymin: 27.91111 xmax: 4.316994 ymax: 43.67333
Geodetic CRS:  ETRS89
Reading layer `Estaciones_Automaticas' from data source 
  `/home/palmer/research/heat-wave-tracker/data/cartography/2aa58725/Estaciones_Automaticas.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 852 features and 9 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: -18.115 ymin: 27.66666 xmax: 4.086429 ymax: 43.78615
Geodetic CRS:  ETRS89
Reading layer `Estaciones_Pluviometricas' from data source 
  `/home/palmer/research/heat-wave-tracker/data/cartography/8892d9c9/Estaciones_Pluviometricas.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 2362 features and 9 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: -18.03113 ymin: 27.64222 xmax: 4.316994 ymax: 43.67333
Geodetic CRS:  ETRS89
> 
> spain_munis = st_read("data/cartography/SIGLIM_Publico_INSPIRE/SHP_ETRS89/recintos_municipales_inspire_peninbal_etrs89/recintos_municipales_inspire_peninbal_etrs89.shp") %>% st_transform(SPAIN_CRS) %>% filter(NATLEVNAME == "Municipio") %>% dplyr::select(municipality_name = NAMEUNIT, NATCODE)
Reading layer `recintos_municipales_inspire_peninbal_etrs89' from data source 
  `/home/palmer/research/heat-wave-tracker/data/cartography/SIGLIM_Publico_INSPIRE/SHP_ETRS89/recintos_municipales_inspire_peninbal_etrs89/recintos_municipales_inspire_peninbal_etrs89.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 8129 features and 9 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: -9.301516 ymin: 35.17045 xmax: 4.327785 ymax: 43.79238
Geodetic CRS:  ETRS89
> 
> station_points = st_join(station_points, spain_munis)
> 
> station_info = station_points %>% st_drop_geometry() %>% dplyr::select(indicativo = INDICATIVO, station_name = NOMBRE, municipality_name, PROVINCIA) %>% distinct()
> 
> write_rds(station_info, file = "data/station_info.Rds")
> 
> these_stations = station_info %>% filter(municipality_name %in% these_munis) %>% pull(indicativo)
> 
> # Loading weather data ####
> 
> weather_daily = fread("~/research/realtime-weather-spain/data/spain_weather_daily_historical.csv.gz") %>% filter(indicativo %in% these_stations) %>% mutate(date = as_date(date))
> 
> # adding latest realtime weather
> weather_realtime = fread("~/research/realtime-weather-spain/data/spain_weather.csv.gz")  %>% filter(idema %in% these_stations) %>% mutate(fint = with_tz(fint, "CET")) %>% pivot_wider(id_cols = c(fint, idema), names_from = measure, values_from = value) %>% mutate(date = as_date(fint)) %>% rename(indicativo = idema)
Error in readBin(inn, what = raw(0L), size = 1L, n = BFR.SIZE) : 
  error reading from the connection
Calls: %>% ... fread -> <Anonymous> -> decompressFile.default -> readBin
In addition: Warning message:
In readBin(inn, what = raw(0L), size = 1L, n = BFR.SIZE) :
  invalid or incomplete compressed data
Execution halted
